<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | Visitor Tracking</title>

    <!-- React & ReactDOM (Production) -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>

    <!-- Prop Types -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Recharts (Stable CDNJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.3/Recharts.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Grid Pattern */
        .bg-grid {
            background-size: 20px 20px;
            background-image: linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        @keyframes fade_in_up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .anim-fade_in_up {
            animation: fade_in_up 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen bg-grid">
    <div id="root" class="h-full"></div>

    <!-- Global Error Handler -->
    <script>
        window.onerror = function (message, source, lineno, colno, error) {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="fixed inset-0 flex items-center justify-center p-4 bg-red-50/50 backdrop-blur-sm z-50">
                    <div class="bg-white border border-red-200 p-8 rounded-2xl max-w-lg shadow-2xl">
                        <div class="flex items-center gap-3 text-red-600 mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                            <h2 class="text-xl font-bold">System Error</h2>
                        </div>
                        <p class="text-slate-700 mb-4">The application encountered an unexpected error.</p>
                        <div class="text-xs text-red-500 bg-red-50 p-4 rounded-lg font-mono overflow-auto border border-red-100 mb-4">
                            ${message}
                        </div>
                         <div class="text-xs text-slate-400">
                            Source: ${source}:${lineno}:${colno}
                        </div>
                        <button onclick="window.location.reload()" class="mt-6 w-full py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Reload Page</button>
                    </div>
                </div>
            `;
            return false;
        };
    </script>

    <script>
        // Ensure Recharts is globally available before Babel runs
        window.confirmRechartsLoaded = function () {
            if (!window.Recharts) {
                console.warn("Recharts not found on require. Retry...");
            } else {
                console.log("Recharts loaded successfully.");
            }
        };
        window.confirmRechartsLoaded();
    </script>

    <script type="text/babel">
        try {
            const { useState, useEffect, useMemo } = React;

            // Explicitly grab Recharts from window to avoid ReferenceError invalid reference
            const RechartsLib = window.Recharts;

            if (!RechartsLib) {
                throw new Error("Visualization library (Recharts) failed to load. Please check your internet connection.");
            }

            const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, AreaChart, Area } = RechartsLib;

            // --- Icons ---
            const IconWrapper = ({ children, className, size = 20 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
            );

            const Icons = {
                Users: (props) => <IconWrapper {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></IconWrapper>,
                Activity: (props) => <IconWrapper {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></IconWrapper>,
                Clock: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></IconWrapper>,
                Globe: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10" /><line x1="2" y1="12" x2="22" y2="12" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></IconWrapper>,
                Trash: (props) => <IconWrapper {...props}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></IconWrapper>,
                AlertCircle: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></IconWrapper>
            };

            const STORAGE_KEY = 'uims_page_analytics';

            const StatCard = ({ title, value, subtext, icon: Icon, color, delay }) => (
                <div className="glass-card p-6 rounded-xl flex items-start justify-between anim-fade_in_up" style={{ animationDelay: `${delay}ms` }}>
                    <div>
                        <h3 className="text-slate-500 text-sm font-medium mb-1">{title}</h3>
                        <div className="text-2xl font-bold text-slate-800">{value}</div>
                        <div className="text-xs text-slate-400 mt-1">{subtext}</div>
                    </div>
                    <div className={`p-3 rounded-lg ${color}`}>
                        <Icon className="text-white" size={24} />
                    </div>
                </div>
            );

            const AnalyticsDashboard = () => {
                const [data, setData] = useState([]);
                const [isLoading, setIsLoading] = useState(true);

                useEffect(() => {
                    const loadData = () => {
                        try {
                            const stored = localStorage.getItem(STORAGE_KEY);
                            if (stored) {
                                const parsed = JSON.parse(stored);
                                // Sort by timestamp desc
                                setData(parsed.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
                            }
                        } catch (e) {
                            console.error("Failed to load analytics", e);
                        }
                        setIsLoading(false);
                    };
                    loadData();
                    const interval = setInterval(loadData, 2000); // Live update
                    return () => clearInterval(interval);
                }, []);

                const stats = useMemo(() => {
                    const uniqueIPs = new Set(data.map(d => d.ip)).size;
                    const totalVisits = data.length;
                    const lastVisit = data.length > 0 ? new Date(data[0].timestamp).toLocaleTimeString() : '-';

                    // Group by hour for chart
                    const chartData = data.reduce((acc, curr) => {
                        const date = new Date(curr.timestamp);
                        const key = `${date.getHours()}:00`;
                        acc[key] = (acc[key] || 0) + 1;
                        return acc;
                    }, {});

                    return { uniqueIPs, totalVisits, lastVisit, chartData };
                }, [data]);

                const clearData = () => {
                    if (confirm('Are you sure you want to clear all analytics data?')) {
                        localStorage.removeItem(STORAGE_KEY);
                        setData([]);
                    }
                };

                const chartDataArray = Object.entries(stats.chartData).map(([name, visits]) => ({ name, visits }));

                return (
                    <div className="max-w-7xl mx-auto p-8">
                        <header className="flex justify-between items-center mb-10 anim-fade_in_up">
                            <div>
                                <h1 className="text-3xl font-bold text-slate-900 tracking-tight">Visitor Analytics</h1>
                                <p className="text-slate-500 mt-2">Real-time tracking of page opens and user engagement.</p>
                            </div>
                            <div className="flex gap-4 items-center">
                                <span className="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-2">
                                    <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                                    Live Tracking
                                </span>
                                <button onClick={clearData} className="text-slate-400 hover:text-red-500 transition-colors p-2 hover:bg-red-50 rounded-lg">
                                    <Icons.Trash size={20} />
                                </button>
                            </div>
                        </header>

                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-8 flex items-start gap-4">
                            <Icons.AlertCircle className="text-amber-600 shrink-0 mt-0.5" />
                            <div>
                                <h4 className="text-sm font-bold text-amber-900">Demo Environment Notice</h4>
                                <p className="text-sm text-amber-800 mt-1">
                                    This analytics dashboard uses <strong>Local Storage</strong>. It tracks visits made from <em>this browser</em> to the main page.
                                    In a real production app, this would connect to a backend database to aggregate data from all users worldwide.
                                </p>
                            </div>
                        </div>

                        {/* Stats Grid */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                            <StatCard
                                title="Total Page Opens"
                                value={stats.totalVisits}
                                subtext="All time tracking"
                                icon={Icons.Activity}
                                color="bg-blue-500"
                                delay={100}
                            />
                            <StatCard
                                title="Unique Users (IPs)"
                                value={stats.uniqueIPs}
                                subtext="Distinct devices tracked"
                                icon={Icons.Users}
                                color="bg-violet-500"
                                delay={200}
                            />
                            <StatCard
                                title="Last Active"
                                value={stats.lastVisit}
                                subtext="Most recent page load"
                                icon={Icons.Clock}
                                color="bg-emerald-500"
                                delay={300}
                            />
                        </div>

                        {/* Main Content Grid */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            {/* Chart Section */}
                            <div className="lg:col-span-2 glass-card rounded-xl p-6 anim-fade_in_up" style={{ animationDelay: '400ms' }}>
                                <h3 className="text-lg font-bold text-slate-800 mb-6">Activity Timeline (Hourly)</h3>
                                <div className="h-[300px] w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={chartDataArray}>
                                            <defs>
                                                <linearGradient id="colorVisits" x1="0" y1="0" x2="0" y2="1">
                                                    <stop offset="5%" stopColor="#8b5cf6" stopOpacity={0.3} />
                                                    <stop offset="95%" stopColor="#8b5cf6" stopOpacity={0} />
                                                </linearGradient>
                                            </defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                            <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{ fill: '#64748b', fontSize: 12 }} />
                                            <YAxis axisLine={false} tickLine={false} tick={{ fill: '#64748b', fontSize: 12 }} />
                                            <Tooltip
                                                contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)' }}
                                                cursor={{ stroke: '#8b5cf6', strokeWidth: 2 }}
                                            />
                                            <Area type="monotone" dataKey="visits" stroke="#8b5cf6" strokeWidth={3} fillOpacity={1} fill="url(#colorVisits)" />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* Recent List */}
                            <div className="glass-card rounded-xl p-6 anim-fade_in_up" style={{ animationDelay: '500ms' }}>
                                <h3 className="text-lg font-bold text-slate-800 mb-4">Recent Visits</h3>
                                <div className="overflow-y-auto max-h-[300px] space-y-3 pr-2">
                                    {data.map((visit, index) => (
                                        <div key={index} className="flex items-center justify-between p-3 rounded-lg bg-white/50 border border-slate-100 hover:bg-white transition-colors">
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-500">
                                                    <Icons.Globe size={14} />
                                                </div>
                                                <div>
                                                    <div className="text-xs font-bold text-slate-700 font-mono">{visit.ip}</div>
                                                    <div className="text-[10px] text-slate-400">{new Date(visit.timestamp).toLocaleDateString()}</div>
                                                </div>
                                            </div>
                                            <div className="text-xs font-semibold text-slate-600">
                                                {new Date(visit.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                            </div>
                                        </div>
                                    ))}
                                    {data.length === 0 && (
                                        <div className="text-center py-10 text-slate-400 text-sm">No visits tracked yet.</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<AnalyticsDashboard />);
        } catch (err) {
            console.error(err);
            // Ensure the error handler above catches this by re-throwing if initial render fails synchronously
            throw err;
        }
    </script>
</body>

</html>