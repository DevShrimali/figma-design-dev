<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIMS - Universal Inventory Management Module</title>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Grid Pattern */
        .bg-grid {
            background-size: 20px 20px;
            background-image: linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
        }

        /* --- Animations --- */
        @keyframes fade_in_center {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .anim-fade_in_center {
            animation: fade_in_center 0.5s ease-out forwards;
        }

        @keyframes slide_up_form {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .anim-slide_up_form {
            animation: slide_up_form 0.5s ease-out forwards;
        }

        @keyframes checkmark_scale_in {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .anim-checkmark_scale_in {
            animation: checkmark_scale_in 0.4s ease-out forwards;
        }

        @keyframes row_expand_fade {
            from {
                height: 0;
                opacity: 0;
            }

            to {
                height: auto;
                opacity: 1;
            }
        }

        .anim-row_expand_fade {
            animation: row_expand_fade 0.5s ease-out forwards;
        }

        @keyframes search_suggestion_pop {
            from {
                transform: scaleY(0);
                transform-origin: top;
            }

            to {
                transform: scaleY(1);
            }
        }

        .anim-search_suggestion_pop {
            animation: search_suggestion_pop 0.3s ease-out forwards;
        }

        @keyframes number_count_up {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .anim-number_count_up {
            animation: number_count_up 0.5s ease-out forwards;
        }

        @keyframes payment_success_pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
            }
        }

        .anim-payment_success_pulse {
            animation: payment_success_pulse 1s infinite;
        }

        @keyframes pulse_line {
            0% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
                transform: scaleX(0.98);
            }

            100% {
                opacity: 0.5;
                transform: scaleX(1);
            }
        }

        .anim-pulse_line {
            animation: pulse_line 1.5s infinite;
        }

        @keyframes log_line_fade {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .anim-log_line_fade {
            animation: log_line_fade 0.3s ease-out forwards;
        }

        @keyframes form_step_reveal {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .anim-form_step_reveal {
            animation: form_step_reveal 0.4s ease-out forwards;
        }

        @keyframes green_tick_fade {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .anim-green_tick_fade {
            animation: green_tick_fade 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes card_stagger_load {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .anim-card_stagger_load {
            animation: card_stagger_load 0.4s ease-out forwards;
        }
    </style>

    <!-- Analytics Tracking -->
    <script>
        (async function trackVisitor() {
            const STORAGE_KEY = 'uims_page_analytics';

            try {
                // 1. Fetch IP
                const response = await fetch('https://api.ipify.org?format=json');
                if (!response.ok) throw new Error('IP fetch failed');
                const data = await response.json();
                const ip = data.ip;

                // 2. Prepare Record
                const visitRecord = {
                    ip: ip,
                    timestamp: new Date().toISOString(),
                    path: window.location.pathname,
                    userAgent: navigator.userAgent
                };

                // 3. Store in LocalStorage (Append)
                let existingData = [];
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) existingData = JSON.parse(stored);
                } catch (e) {
                    console.warn('Could not parse existing analytics', e);
                }

                existingData.push(visitRecord);

                // Limit to last 500 records to prevent quota issues
                if (existingData.length > 500) {
                    existingData = existingData.slice(-500);
                }

                localStorage.setItem(STORAGE_KEY, JSON.stringify(existingData));
                console.log('Visitor tracked:', ip);

            } catch (err) {
                console.error('Tracking failed:', err);
                // Fallback for offline/blocked: track as "Unknown"
                const fallbackRecord = {
                    ip: 'Unknown/Offline',
                    timestamp: new Date().toISOString(),
                    path: window.location.pathname,
                    userAgent: navigator.userAgent
                };
                let existingData = [];
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) existingData = JSON.parse(stored);
                } catch (e) { }
                existingData.push(fallbackRecord);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(existingData));
            }
        })();
    </script>
</head>

<body class="bg-slate-50 text-slate-900 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icons ---
        const IconWrapper = ({ children, className, size = 24, style, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style} {...props}>{children}</svg>
        );

        const Icons = {
            X: (props) => <IconWrapper {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></IconWrapper>,
            Activity: (props) => <IconWrapper {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2" /></IconWrapper>,
            Database: (props) => <IconWrapper {...props}><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></IconWrapper>,
            ShieldCheck: (props) => <IconWrapper {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /><path d="m9 12 2 2 4-4" /></IconWrapper>,
            Layers: (props) => <IconWrapper {...props}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z" /><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65" /><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65" /></IconWrapper>,
            FileText: (props) => <IconWrapper {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><line x1="10" x2="8" y1="9" y2="9" /></IconWrapper>,
            PlayCircle: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10" /><polygon points="10 8 16 12 10 16 10 8" /></IconWrapper>,
            ArrowRight: (props) => <IconWrapper {...props}><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></IconWrapper>,
            Crown: (props) => <IconWrapper {...props}><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14" /></IconWrapper>
        };

        const { X, Activity, Database, ShieldCheck, Layers, FileText, PlayCircle, ArrowRight, Crown } = Icons;

        // --- JSON Data: EXPANDED DETAILED FLOW WITH EXAMPLES ---
        const SYSTEM_DATA = {
            "phases": {
                "phase_1": { "name": "Inventory Management System", "color": "blue" },
                "phase_2": { "name": "POS & Billing System", "color": "purple" }
            },
            "flowchart": [
                // --- AUTHENTICATION ---
                { "id": "START", "phase": "phase_1", "type": "system", "name": "Enlight Vision (SaaS Provider)", "animation": "fade_in_center", "next": ["AUTH_01"] },
                {
                    "id": "AUTH_01", "phase": "phase_1", "type": "screen", "name": "Login Screen",
                    "inputs": ["email", "password"], "animation": "fade_in_center", "next": ["AUTH_VAL"],
                    "example_data": { "email": "employee@store.com", "password": "*****" }
                },
                {
                    "id": "AUTH_VAL", "phase": "phase_1", "type": "system", "name": "Validate Creds",
                    "data_flow": { "check": "db_hash_match" }, "animation": "pulse_line", "next": ["COMPANY_MST"],
                    "example_data": { "user_id": "EMP-882", "role": "MANAGER", "auth_status": "SUCCESS" }
                },

                // --- SAAS MASTERS (Context Loading) ---
                {
                    "id": "COMPANY_MST", "phase": "phase_1", "type": "master_data", "name": "EV Mart",
                    "animation": "fade_in_center", "next": ["STAFF_PROFILE"],
                    "example_data": {
                        "company_id": "EV-US-992",
                        "name": "EV Mart (US)",
                        "address": { "street": "400 Broad St", "city": "Seattle", "pincode": "98109", "state": "WA" },
                        "tax_config": { "tax_id": "EIN-99-887766", "region": "Washington (State)" },
                        "biz_type": "Food & Pharma"
                    }
                },
                {
                    "id": "STAFF_PROFILE", "phase": "phase_1", "type": "compliance", "name": "Staff Profiling",
                    "animation": "fade_in_center", "next": ["DASH_01"],
                    "example_data": { "profiles": [{ "role": "STORE_MANAGER", "access": "FULL_ACCESS" }] }
                },

                // --- DASHBOARD ---
                { "id": "DASH_01", "phase": "phase_1", "type": "dashboard", "name": "Inventory Dashboard", "data_sources": ["items", "stock_ledger"], "animation": "card_stagger_load", "next": ["TAX_MST", "VENDOR_MST", "ITEM_MST", "INWARD_ENTRY", "SO_GEN", "STOCK_VIEW_01"], "example_data": { "widgets": { "low_stock": 5, "todays_sales": 12000 } } },

                // --- MASTER DATA WING ---
                {
                    "id": "TAX_MST", "phase": "phase_1", "type": "master_data", "name": "Tax Config",
                    "animation": "form_step_reveal", "next": ["ITEM_MST", "POS_TAX"],
                    "example_data": {
                        "standard": "WA State Sales Tax",
                        "rules": [
                            { "code": "WA_STATE", "rate": 0.065, "type": "State Tax" },
                            { "code": "SEATTLE_LOC", "rate": 0.0375, "type": "City Tax" },
                            { "code": "PHARMA_RX", "rate": 0.00, "type": "Exempt" }
                        ]
                    }
                },
                {
                    "id": "VENDOR_MST", "phase": "phase_1", "type": "master_data", "name": "Vendor Master",
                    "animation": "form_step_reveal", "next": ["ITEM_MST"],
                    "example_data": { "id": "V-001", "name": "Acme Supplies", "term": "Net 30" }
                },
                {
                    "id": "ITEM_MST", "phase": "phase_1", "type": "master_data", "name": "Item Master",
                    "inputs": ["sku", "name", "price", "expiry", "tax_cat"], "animation": "form_step_reveal", "next": ["MASTER_VAL"],
                    "example_data": { "sku": "RX-IBU-200", "name": "Ibuprofen 200mg", "price": 12.50, "type": "Pharma", "tax_cat": "GST_18" }
                },
                {
                    "id": "MASTER_VAL", "phase": "phase_1", "type": "calculation", "name": "Duplication Check",
                    "logic": ["exists(sku)"], "animation": "pulse_line", "next": ["STORAGE_01"],
                    "example_data": { "sku_check": "RX-IBU-200", "is_duplicate": false }
                },
                {
                    "id": "STORAGE_01", "phase": "phase_1", "type": "master_data", "name": "Warehouse Model",
                    "animation": "fade_in_center", "next": ["STOCK_LEDGER_01"],
                    "example_data": {
                        "warehouses": [
                            {
                                "name": "Seattle DC",
                                "zones": [
                                    {
                                        "name": "Zone A (Cold Chain)",
                                        "racks": [
                                            {
                                                "id": "C1", "bins": [
                                                    { "id": "A-C1-01", "status": "occupied", "item": "Insulin Pen" },
                                                    { "id": "A-C1-02", "status": "empty" }
                                                ]
                                            },
                                            {
                                                "id": "C2", "bins": [
                                                    { "id": "A-C2-01", "status": "occupied", "item": "Vaccine" },
                                                    { "id": "A-C2-02", "status": "maintenance" }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        "name": "Zone B (Ambient Food)",
                                        "racks": [
                                            {
                                                "id": "R1", "bins": [
                                                    { "id": "B-R1-01", "status": "occupied", "item": "Org. Chips" },
                                                    { "id": "B-R1-02", "status": "occupied", "item": "Energy Bar" }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                },

                // --- VIEW STOCK ---
                { "id": "STOCK_VIEW_01", "phase": "phase_1", "type": "screen", "name": "View Stock", "animation": "card_stagger_load", "next": [], "example_data": { "filter": "Category=Shoes", "results": 45 } },

                // --- INWARD PROCESS (SIMPLIFIED) ---
                {
                    "id": "INWARD_ENTRY", "phase": "phase_1", "type": "transaction", "name": "Invoice",
                    "inputs": ["method", "ref_no", "items"], "animation": "slide_up_form", "next": ["PUTAWAY"],
                    "example_data": {
                        "in_id": "INV-1002",
                        "method": "Job Work (JW)",
                        "allowed_methods": ["Purchase Order", "Production Voucher", "Petty Cash", "Job Work", "Sales Return"],
                        "items_count": 120
                    }
                },
                {
                    "id": "PUTAWAY", "phase": "phase_1", "type": "transaction", "name": "Inventory",
                    "data_flow": { "assign": "bin_id" }, "animation": "slide_up_form", "next": ["STOCK_LEDGER_01"],
                    "example_data": { "item": "Ibuprofen", "target_bin": "B-R1-05" }
                },

                // --- OUTWARD PROCESS (SIMPLIFIED) ---
                {
                    "id": "SO_GEN", "phase": "phase_1", "type": "transaction", "name": "Sales Order",
                    "inputs": ["customer", "items"], "animation": "slide_up_form", "next": ["STOCK_LEDGER_01"],
                    "example_data": { "so_id": "SO-551", "customer": "John Doe" }
                },

                // --- CORE SYSTEM ---
                {
                    "id": "STOCK_LEDGER_01", "phase": "phase_1", "type": "system", "name": "Inv Ledger",
                    "data_structure": ["opening", "in/out", "closing"], "animation": "row_expand_fade", "next": ["AUDIT_01"],
                    "example_data": { "txn": "Stock Mvmnt", "qty": -2 }
                },
                {
                    "id": "AUDIT_01", "phase": "phase_1", "type": "compliance", "name": "Audit Logs",
                    "captures": ["before", "after", "user"], "animation": "log_line_fade", "next": ["END_AUDIT"],
                    "example_data": { "log": "Action by User A" }
                },
                { "id": "END_AUDIT", "phase": "phase_1", "type": "system", "name": "Complete", "animation": "fade_in_center", "next": [] },

                // --- PHASE 2: POS FLOW ---
                { "id": "POS_START", "phase": "phase_2", "type": "system", "name": "POS Start", "animation": "fade_in_center", "next": ["POS_01"] },
                {
                    "id": "POS_01", "phase": "phase_2", "type": "screen", "name": "Item Search",
                    "inputs": ["barcode"], "animation": "search_suggestion_pop", "next": ["POS_STOCK"],
                    "example_data": { "scan": "88092281" }
                },
                {
                    "id": "POS_STOCK", "phase": "phase_2", "type": "system", "name": "Stock Check",
                    "data_flow": { "fetch": "qty" }, "animation": "pulse_line", "next": ["POS_ADD"],
                    "example_data": { "found": 48 }
                },
                {
                    "id": "POS_ADD", "phase": "phase_2", "type": "transaction", "name": "Add to Cart",
                    "animation": "card_stagger_load", "next": ["POS_DISC"],
                    "example_data": { "total": 120.00 }
                },
                {
                    "id": "POS_DISC", "phase": "phase_2", "type": "calculation", "name": "Discount",
                    "logic": ["Per Item", "Fixed Amount", "Overall %"], "animation": "number_count_up", "next": ["POS_TAX"],
                    "example_data": { "type": "Overall %", "value": 10, "disc_amt": 12.00 }
                },
                {
                    "id": "POS_TAX", "phase": "phase_2", "type": "calculation", "name": "Tax Calc",
                    "logic": ["sales_tax_wa"], "animation": "number_count_up", "next": ["POS_PAY_NOW", "POS_PAY_LATER"],
                    "example_data": { "tax": 10.10 }
                },
                {
                    "id": "POS_PAY_NOW", "phase": "phase_2", "type": "payment", "name": "Pay Now",
                    "methods": ["Credit Card", "Cash", "UPI"],
                    "animation": "slide_up_form", "next": ["POS_GATE"],
                    "example_data": { "amt": 127.44, "status": "Paid" }
                },
                {
                    "id": "POS_PAY_LATER", "phase": "phase_2", "type": "approval", "name": "Pay Later",
                    "logic": ["Validate(Name, Contact, TaxID)"],
                    "animation": "shake_horizontal", "next": ["POS_RCPT"],
                    "example_data": { "customer": "John Doe", "credit_limit": "OK" }
                },
                {
                    "id": "POS_GATE", "phase": "phase_2", "type": "integration", "name": "Gateway",
                    "action": "auth", "animation": "pulse_line", "next": ["POS_RCPT"],
                    "example_data": { "status": "OK" }
                },
                {
                    "id": "POS_RCPT", "phase": "phase_2", "type": "screen", "name": "Receipt",
                    "animation": "fade_in_center", "next": ["POS_SYNC"],
                    "example_data": { "print": "OK" }
                },
                {
                    "id": "POS_SYNC", "phase": "phase_2", "type": "integration", "name": "Inv Sync",
                    "action": "api_post", "animation": "pulse_line", "next": [],
                    "example_data": { "sync": "done" }
                }
            ]
        };

        const NODE_POSITIONS = {
            // --- CENTER (350) ---
            "START": { x: 350, y: 50 },
            "AUTH_01": { x: 350, y: 150 },
            "AUTH_VAL": { x: 350, y: 250 },
            "DASH_01": { x: 350, y: 380 },

            // --- LEFT WING: MASTERS (50) ---
            "VENDOR_MST": { x: 50, y: 380 },
            "ITEM_MST": { x: 50, y: 480 },
            "MASTER_VAL": { x: 50, y: 580 },
            "STORAGE_01": { x: 50, y: 700 },

            // --- RIGHT WING: VIEW (650) ---
            "COMPANY_MST": { x: 650, y: 50 },  // Top: Company Context
            "STAFF_PROFILE": { x: 650, y: 150 }, // Below: Staff Context
            "STOCK_VIEW_01": { x: 650, y: 380 },

            // --- INWARD CHAIN (200) ---
            "INWARD_ENTRY": { x: 200, y: 750 },
            "PUTAWAY": { x: 200, y: 950 },

            // --- OUTWARD CHAIN (550) ---
            "SO_GEN": { x: 550, y: 550 },

            // --- MERGE POINT ---
            "STOCK_LEDGER_01": { x: 350, y: 1100 },
            "AUDIT_01": { x: 350, y: 1250 },
            "END_AUDIT": { x: 350, y: 1400 },

            // --- POS FLOW (900) ---
            "TAX_MST": { x: -120, y: 380 },   // Moved Left of Vendor Master
            "POS_START": { x: 900, y: 50 },
            "POS_01": { x: 900, y: 150 },
            "POS_STOCK": { x: 900, y: 250 },
            "POS_ADD": { x: 900, y: 350 },
            "POS_DISC": { x: 900, y: 450 },
            "POS_TAX": { x: 900, y: 550 },
            "POS_PAY_NOW": { x: 800, y: 650 },   // Split Left
            "POS_PAY_LATER": { x: 1000, y: 650 }, // Split Right
            "POS_GATE": { x: 800, y: 750 },      // Below Pay Now
            "POS_RCPT": { x: 900, y: 850 },      // Merge back
            "POS_SYNC": { x: 900, y: 950 },
        };

        const TYPE_COLORS = {
            screen: "bg-blue-100 border-blue-300 text-blue-800",
            dashboard: "bg-indigo-100 border-indigo-300 text-indigo-800",
            master_data: "bg-amber-100 border-amber-400 text-amber-900 font-bold shadow-amber-200/50",
            transaction: "bg-amber-100 border-amber-300 text-amber-800",
            approval: "bg-pink-100 border-pink-300 text-pink-800",
            system: "bg-emerald-100 border-emerald-300 text-emerald-800",
            calculation: "bg-violet-100 border-violet-300 text-violet-800",
            payment: "bg-green-100 border-green-300 text-green-800",
            integration: "bg-orange-100 border-orange-300 text-orange-800",
            compliance: "bg-gray-800 border-gray-600 text-gray-100",
        };

        const MODULES = {
            ALL: [],
            INWARD: ['INWARD_ENTRY', 'PUTAWAY'],
            OUTWARD: ['SO_GEN'],
            POS: ['POS_START', 'POS_01', 'POS_STOCK', 'POS_ADD', 'POS_DISC', 'POS_TAX', 'POS_PAY_NOW', 'POS_PAY_LATER', 'POS_GATE', 'POS_RCPT', 'POS_SYNC'],
            ADMIN: ['START', 'AUTH_01', 'AUTH_VAL', 'COMPANY_MST', 'STAFF_PROFILE', 'DASH_01', 'TAX_MST', 'VENDOR_MST', 'ITEM_MST', 'MASTER_VAL', 'STORAGE_01', 'STOCK_VIEW_01', 'STOCK_LEDGER_01', 'AUDIT_01', 'END_AUDIT']
        };

        const FlowchartApp = () => {
            const [selectedNode, setSelectedNode] = useState(null);
            const [activeModule, setActiveModule] = useState('ALL');
            const [hoveredNode, setHoveredNode] = useState(null);
            const [zoom, setZoom] = useState(0.8);
            const [pan, setPan] = useState({ x: 50, y: 50 });
            const [isDragging, setIsDragging] = useState(false);
            const dragStart = useRef({ x: 0, y: 0 });

            const handleMouseDown = (e) => {
                if (e.button !== 0) return;
                setIsDragging(true);
                dragStart.current = { x: e.clientX - pan.x, y: e.clientY - pan.y };
                e.preventDefault();
            };

            const handleMouseMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                setPan({ x: e.clientX - dragStart.current.x, y: e.clientY - dragStart.current.y });
            };

            const handleMouseUp = () => setIsDragging(false);

            const getCoords = (id) => NODE_POSITIONS[id] || { x: 0, y: 0 };

            const connections = useMemo(() => {
                const lines = [];
                SYSTEM_DATA.flowchart.forEach(source => {
                    if (source.next) {
                        source.next.forEach(targetId => {
                            if (!NODE_POSITIONS[targetId]) return;
                            const start = getCoords(source.id);
                            const end = getCoords(targetId);
                            const startX = start.x + 70; // Center (width 140/2)
                            const startY = start.y + 60; // Bottom
                            const endX = end.x + 70; // Center
                            const endY = end.y; // Top

                            // Adjust simple bezier
                            const controlY = (startY + endY) / 2;
                            let d = `M ${startX} ${startY} C ${startX} ${controlY}, ${endX} ${controlY}, ${endX} ${endY}`;

                            // Tax MST to POS TAX (Long range connection)
                            if (source.id === 'TAX_MST' && targetId === 'POS_TAX') {
                                d = `M ${start.x + 140} ${start.y + 30} C ${start.x + 400} ${start.y - 100}, ${end.x - 200} ${end.y - 100}, ${end.x + 70} ${end.y}`;
                            }

                            // Pay Later Merge
                            if (source.id === 'POS_PAY_LATER' && targetId === 'POS_RCPT') {
                                d = `M ${startX} ${startY} C ${startX} ${startY + 50}, ${endX} ${startY + 50}, ${endX} ${endY}`;
                            }

                            // Pay Now Merge via Gate
                            if (source.id === 'POS_GATE' && targetId === 'POS_RCPT') {
                                d = `M ${startX} ${startY} C ${startX} ${startY + 50}, ${endX} ${startY + 50}, ${endX} ${endY}`;
                            }

                            lines.push({ id: `${source.id}-${targetId}`, source: source.id, target: targetId, d });
                        });
                    }
                });
                return lines;
            }, []);

            const isNodeVisible = (nodeId) => {
                if (activeModule === 'ALL') return true;
                return MODULES[activeModule].includes(nodeId);
            };

            return (
                <div className="flex w-full h-full bg-slate-50 relative">
                    {/* Module Filter Bar */}
                    <div className="absolute top-4 left-1/2 -translate-x-1/2 z-50 bg-white/90 backdrop-blur shadow-lg border border-slate-200 rounded-full p-1.5 flex gap-1">
                        {Object.keys(MODULES).map(mod => (
                            <button
                                key={mod}
                                onClick={() => { setActiveModule(mod); setSelectedNode(null); }}
                                className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all ${activeModule === mod ? 'bg-slate-800 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100'}`}
                            >
                                {mod === 'ALL' ? 'FULL SYSTEM' : mod}
                            </button>
                        ))}
                    </div>
                    <div className="flex-1 overflow-hidden bg-grid relative cursor-move"
                        onWheel={(e) => setZoom(Math.min(2, Math.max(0.4, zoom + (e.deltaY * -0.001))))}
                        onMouseDown={handleMouseDown}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                        onMouseLeave={handleMouseUp}
                    >
                        <div className="absolute top-0 left-0 transition-transform duration-75 ease-out origin-top-left"
                            style={{ width: '2500px', height: '3500px', transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`, transformOrigin: '0 0' }}>

                            <svg className="absolute top-0 left-0 w-full h-full pointer-events-none z-0">
                                <defs>
                                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" /></marker>
                                    <marker id="arrowhead-active" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6" /></marker>
                                </defs>
                                {connections.map(line => {
                                    const isActive = selectedNode && (line.source === selectedNode.id || line.target === selectedNode.id);
                                    const isVisible = isNodeVisible(line.source) && isNodeVisible(line.target);
                                    return (
                                        <g key={line.id} style={{ opacity: isVisible ? 1 : 0.05, transition: 'opacity 0.3s' }}>
                                            <path d={line.d} stroke={isActive ? "#3b82f6" : "#cbd5e1"} strokeWidth={isActive ? "3" : "2"} fill="none" markerEnd={isActive ? "url(#arrowhead-active)" : "url(#arrowhead)"} className="transition-all duration-300" />
                                            {isActive && (
                                                <circle r="4" fill="#3b82f6">
                                                    <animateMotion dur="1s" repeatCount="indefinite" path={line.d} />
                                                </circle>
                                            )}
                                        </g>
                                    );
                                })}
                            </svg>

                            {SYSTEM_DATA.flowchart.map(node => {
                                if (!NODE_POSITIONS[node.id]) return null;
                                const pos = NODE_POSITIONS[node.id];
                                const isSelected = selectedNode?.id === node.id;
                                const isHovered = hoveredNode === node.id;
                                const phaseColor = node.phase === 'phase_1' ? 'border-b-4 border-b-blue-500' : 'border-b-4 border-b-purple-500';

                                const isVisible = isNodeVisible(node.id);

                                return (
                                    <div key={node.id}
                                        onClick={() => setSelectedNode(node)}
                                        onMouseEnter={() => setHoveredNode(node.id)}
                                        onMouseLeave={() => setHoveredNode(null)}
                                        className={`absolute w-[140px] p-3 rounded-lg shadow-sm border bg-white cursor-pointer transition-all duration-300 z-10 hover:shadow-lg ${phaseColor} ${isSelected ? 'ring-2 ring-blue-500 scale-105 shadow-xl' : 'border-slate-200'}`}
                                        style={{
                                            left: pos.x,
                                            top: pos.y,
                                            opacity: isVisible ? 1 : 0.1,
                                            pointerEvents: isVisible ? 'auto' : 'none',
                                            filter: isVisible ? 'none' : 'grayscale(100%)'
                                        }}
                                    >
                                        <div className="text-[10px] font-mono text-slate-400 uppercase mb-1 flex items-center justify-between">
                                            <span>{node.name.length < 15 ? node.id : ''}</span>
                                            {node.type === 'master_data' && <Crown size={12} className="text-amber-500 fill-amber-200" />}
                                        </div>
                                        <div className="text-xs font-bold text-slate-700 leading-tight mb-2">{node.name}</div>
                                        <div className={`text-[9px] px-1.5 py-0.5 rounded w-fit capitalize ${TYPE_COLORS[node.type] || 'bg-slate-100 text-slate-600'}`}>{node.type.replace('_', ' ')}</div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* Static Phase Legend */}
                        <div className="absolute bottom-4 left-4 bg-white/90 p-3 rounded-lg shadow border border-slate-200 backdrop-blur-sm z-50">
                            <div className="text-[10px] font-bold text-slate-400 uppercase mb-2">System Phases</div>
                            <div className="flex items-center gap-3 mb-1">
                                <span className="w-3 h-3 rounded-full bg-blue-500 shadow-sm ring-1 ring-blue-100"></span>
                                <span className="text-xs font-semibold text-slate-700">Phase 1: Inventory System</span>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className="w-3 h-3 rounded-full bg-purple-500 shadow-sm ring-1 ring-purple-100"></span>
                                <span className="text-xs font-semibold text-slate-700">Phase 2: POS Integration</span>
                            </div>
                        </div>
                        <div className="absolute top-4 left-4 bg-white/80 p-2 rounded shadow text-xs font-mono">UIMS Architecture v1.0</div>

                        {/* Zoom Controls */}
                        <div className="absolute bottom-4 right-4 flex flex-col gap-2 z-50">
                            <button onClick={() => setZoom(z => Math.min(2, z + 0.1))} className="bg-white p-2 rounded-full shadow-lg border border-slate-200 hover:bg-slate-50 text-slate-600 font-bold w-10 h-10 flex items-center justify-center text-lg">
                                +
                            </button>
                            <button onClick={() => setZoom(z => Math.max(0.4, z - 0.1))} className="bg-white p-2 rounded-full shadow-lg border border-slate-200 hover:bg-slate-50 text-slate-600 font-bold w-10 h-10 flex items-center justify-center text-lg">
                                -
                            </button>
                        </div>
                    </div>

                    {/* Inspector Panel - Rich Version */}
                    <div className="w-80 bg-white border-l border-slate-200 shadow-xl flex flex-col z-20">
                        {selectedNode ? (
                            <>
                                <div className="p-6 border-b border-slate-100 bg-slate-50">
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="font-mono text-xs font-bold text-slate-400 bg-white border border-slate-200 px-2 py-1 rounded">{selectedNode.id}</span>
                                        <button onClick={() => setSelectedNode(null)} className="text-slate-400 hover:text-slate-600"><X size={18} /></button>
                                    </div>
                                    <h2 className="text-xl font-bold text-slate-800 mb-1">{selectedNode.name}</h2>
                                    <span className={`text-xs px-2 py-0.5 rounded-full capitalize border ${TYPE_COLORS[selectedNode.type]}`}>{selectedNode.type.replace('_', ' ')}</span>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 space-y-6">

                                    {/* Animation Info */}
                                    <div className="bg-slate-50 rounded-xl p-4 border border-slate-200 flex items-center justify-between">
                                        <div className="flex items-center gap-2 text-sm font-semibold text-slate-700">
                                            <PlayCircle size={16} className="text-blue-500" />
                                            <span>Animation</span>
                                        </div>
                                        <div className="text-xs font-mono text-slate-400">{selectedNode.animation}</div>
                                    </div>

                                    {/* Data Flow Section */}
                                    {(selectedNode.inputs || selectedNode.data_sources || selectedNode.data_flow) && (
                                        <div>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                                <Database size={14} /> Data Flow
                                            </h3>
                                            <div className="space-y-2">
                                                {selectedNode.inputs && (
                                                    <div className="text-sm">
                                                        <span className="font-semibold text-slate-600 block text-xs mb-1">INPUTS</span>
                                                        <div className="flex flex-wrap gap-1">
                                                            {selectedNode.inputs.map(i => <span key={i} className="px-1.5 py-0.5 bg-slate-100 rounded text-slate-600 font-mono text-[10px] border border-slate-200">{i}</span>)}
                                                        </div>
                                                    </div>
                                                )}
                                                {selectedNode.data_sources && (
                                                    <div className="text-sm">
                                                        <span className="font-semibold text-slate-600 block text-xs mb-1">SOURCES</span>
                                                        <div className="flex flex-wrap gap-1">
                                                            {selectedNode.data_sources.map(i => <span key={i} className="px-1.5 py-0.5 bg-indigo-50 text-indigo-700 rounded font-mono text-[10px] border border-indigo-100">{i}</span>)}
                                                        </div>
                                                    </div>
                                                )}
                                                {selectedNode.data_flow && (
                                                    <div className="text-sm">
                                                        <span className="font-semibold text-slate-600 block text-xs mb-1">LOGIC</span>
                                                        <div className="bg-slate-50 p-2 rounded border border-slate-200 font-mono text-[10px] text-slate-600">
                                                            {JSON.stringify(selectedNode.data_flow).replace(/{|}|"/g, '').replace(/:/g, ': ')}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {/* Warehouse Visualizer - Specific Check */}
                                    {selectedNode.id === 'STORAGE_01' && selectedNode.example_data?.warehouses && (
                                        <div className="mb-6">
                                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                                <Icons.Layers size={14} /> Warehouse Hierarchy
                                            </h3>
                                            <div className="space-y-4">
                                                {selectedNode.example_data.warehouses.map((wh, whIdx) => (
                                                    <div key={whIdx} className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                                                        <div className="text-xs font-bold text-slate-700 mb-2 flex items-center gap-2">
                                                            <div className="w-2 h-2 rounded-full bg-slate-400"></div>
                                                            {wh.name}
                                                        </div>

                                                        {/* Zones Loop */}
                                                        <div className="space-y-3 pl-3 border-l-2 border-slate-200 ml-1">
                                                            {wh.zones.map((zone, zIdx) => (
                                                                <div key={zIdx}>
                                                                    <div className="text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">{zone.name}</div>

                                                                    {/* Racks Loop */}
                                                                    <div className="space-y-2">
                                                                        {zone.racks.map((rack, rIdx) => (
                                                                            <div key={rIdx} className="bg-white border border-slate-100 rounded p-2 shadow-sm">
                                                                                <div className="text-[9px] font-mono text-slate-400 mb-1">RACK: {rack.id}</div>
                                                                                <div className="grid grid-cols-2 gap-2">
                                                                                    {rack.bins.map(bin => (
                                                                                        <div key={bin.id}
                                                                                            className={`p-2 rounded border text-center relative group
                                                                                            ${bin.status === 'occupied' ? 'bg-blue-50 border-blue-200 text-blue-700' :
                                                                                                    bin.status === 'maintenance' ? 'bg-orange-50 border-orange-200 text-orange-700' : 'bg-slate-50 border-slate-100 text-slate-400'}`}>
                                                                                            <div className="text-[9px] font-mono">{bin.id}</div>
                                                                                            {bin.status === 'occupied' && <div className="text-[8px] font-bold truncate mt-0.5">{bin.item}</div>}
                                                                                        </div>
                                                                                    ))}
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Company Profile Visualizer */}
                                    {selectedNode.id === 'COMPANY_MST' && selectedNode.example_data?.tax_config && (
                                        <div className="mb-6">
                                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                                <Icons.Activity size={14} /> Business Context
                                            </h3>
                                            <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 space-y-3">
                                                <div className="flex items-start gap-3">
                                                    <div className="w-8 h-8 rounded bg-amber-100 flex items-center justify-center text-amber-600 font-bold border border-amber-200 shrink-0">
                                                        {selectedNode.example_data.name.substring(0, 1)}
                                                    </div>
                                                    <div>
                                                        <div className="text-xs font-bold text-slate-700">{selectedNode.example_data.name}</div>
                                                        <div className="text-[10px] text-slate-500">{selectedNode.example_data.address.city}, {selectedNode.example_data.address.pincode}</div>
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-2 gap-2">
                                                    <div className="bg-white p-2 rounded border border-slate-100 shadow-sm">
                                                        <div className="text-[9px] font-bold text-slate-400 uppercase mb-1">Business Type</div>
                                                        <div className="text-[10px] font-mono text-blue-600 bg-blue-50 px-1 py-0.5 rounded w-fit">{selectedNode.example_data.biz_type}</div>
                                                    </div>
                                                    <div className="bg-white p-2 rounded border border-slate-100 shadow-sm">
                                                        <div className="text-[9px] font-bold text-slate-400 uppercase mb-1">Tax Region</div>
                                                        <div className="text-[10px] font-mono text-slate-600 truncate">{selectedNode.example_data.tax_config.region}</div>
                                                    </div>
                                                </div>

                                                <div className="text-[9px] text-slate-400 pt-2 border-t border-slate-200 flex items-center gap-1">
                                                    <Icons.ShieldCheck size={10} />
                                                    Tax ID: {selectedNode.example_data.tax_config.tax_id}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Staff Profiling Visualizer */}
                                    {selectedNode.id === 'STAFF_PROFILE' && selectedNode.example_data?.profiles && (
                                        <div className="mb-6">
                                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                                <Icons.ShieldCheck size={14} /> Active Staff Roles
                                            </h3>
                                            <div className="space-y-3">
                                                {selectedNode.example_data.profiles.map(p => (
                                                    <div key={p.id} className="flex items-center gap-3 p-2 bg-slate-50 rounded border border-slate-200 shadow-sm">
                                                        <div className="w-8 h-8 rounded-full bg-slate-200 overflow-hidden shrink-0">
                                                            <img src={p.img} alt="usr" className="w-full h-full object-cover" />
                                                        </div>
                                                        <div>
                                                            <div className="text-[10px] font-bold text-slate-700">{p.role.replace('_', ' ')}</div>
                                                            <div className="text-[9px] font-mono text-slate-400">{p.id}  <span className="text-green-600 font-bold">{p.access}</span></div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Actor Information */}
                                    {selectedNode.actor && (
                                        <div className="bg-amber-50 p-3 rounded-lg border border-amber-100 text-sm text-amber-900 flex items-start gap-2">
                                            <ShieldCheck size={16} className="mt-0.5 shrink-0" />
                                            <div>
                                                <div className="font-bold text-xs uppercase">Restricted Actor</div>
                                                <div className="text-xs mt-0.5">{selectedNode.actor}</div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Example Payload Section */}
                                    {selectedNode.example_data && (
                                        <div>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                                <FileText size={14} /> Example Payload
                                            </h3>
                                            <div className="bg-slate-900 rounded-lg p-3 overflow-x-auto border border-slate-800 shadow-inner group relative">
                                                <div className="absolute top-2 right-2 flex gap-1">
                                                    <div className="w-2 h-2 rounded-full bg-red-400"></div>
                                                    <div className="w-2 h-2 rounded-full bg-yellow-400"></div>
                                                    <div className="w-2 h-2 rounded-full bg-green-400"></div>
                                                </div>
                                                <pre className="text-[10px] font-mono text-green-400 leading-relaxed mt-2">
                                                    {JSON.stringify(selectedNode.example_data, null, 2)}
                                                </pre>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </>
                        ) : (
                            <div className="h-full flex flex-col items-center justify-center text-slate-400 p-8 text-center">
                                <Layers size={48} strokeWidth={1} className="mb-4 opacity-50" />
                                <h3 className="font-semibold text-slate-600">Full System Overview</h3>
                                <p className="text-sm mt-2">Click nodes to inspect data structure.</p>
                            </div>
                        )}
                    </div>
                </div >
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FlowchartApp />);
    </script>
</body>

</html>